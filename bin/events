#!/bin/perl

$FOCUS_LOOP=0;

sub window_events {
  open(WIN, "xev -root -event substructure |");

  $LAST_EVENT="";

  while(<WIN>) {
    chomp();
    if ($_ =~ /^MapNotify/ || $_ =~ /^DestroyNotify/) {
      $LAST_EVENT = $_;
    }
    elsif ($LAST_EVENT ne "") {
      if ($_ eq "") {
        $LAST_EVENT = "";
      }
      else {
        print("$LAST_EVENT\n");
        print("$_\n");

        focus_events();
      }
    }
  }
  close(WIN);
}

sub focus_events {
  if ($FOCUS_LOOP > 0) {
    print("kill previous $FOCUS_LOOP\n");
    kill($FOCUS_LOOP);
  }

  $FOCUS_LOOP = open(FIN, "xdotool search --onlyvisible . behave %@ focus getwindowname |");
  if (fork() == 0) {
    while(<FIN>) {
      chomp();
      print("X:$_\n");
    }
    close(FIN);
  }
}

window_events();
